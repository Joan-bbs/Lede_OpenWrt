name: Build OpenWrt

on:
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * 5'  # æ¯å‘¨å…­å‡Œæ™¨ 4 ç‚¹ç¼–è¯‘

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # â­ SAFE CACHEï¼šåªç¼“å­˜ dlï¼Œç¨³å®šä¸æ±¡æŸ“å·¥å…·é“¾
    - name: Cache DL
      uses: actions/cache@v4
      with:
        path: openwrt/dl
        key: ${{ runner.os }}-openwrt-dl-${{ env.REPO_BRANCH }}
        restore-keys: |
          ${{ runner.os }}-openwrt-dl-

    - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev \
          libz-dev patch unzip zlib1g-dev lib32gcc-s1 libc6-dev-i386 subversion flex \
          uglifyjs p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto \
          qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler \
          g++-multilib antlr3 gperf libtool-bin pkg-config

    - name: å…‹éš† OpenWrt æºç 
      run: |
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt
        [ -f $GITHUB_WORKSPACE/$FEEDS_CONF ] && cp $GITHUB_WORKSPACE/$FEEDS_CONF ./feeds.conf.default

    - name: DIY ç¬¬1éƒ¨åˆ†
      run: |
        cd openwrt
        bash $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: æ›´æ–° & å®‰è£… feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: DIY ç¬¬2éƒ¨åˆ†
      run: |
        cd openwrt
        bash $GITHUB_WORKSPACE/$DIY_P2_SH

    - name: å¯¼å…¥è‡ªå®šä¹‰é…ç½®
      run: |
        cd openwrt
        [ -f $GITHUB_WORKSPACE/$CONFIG_FILE ] && cp $GITHUB_WORKSPACE/$CONFIG_FILE .config

    # â­ è‡ªåŠ¨ fallbackï¼šç¼–è¯‘å¤±è´¥è‡ªåŠ¨æ¸…ç†å·¥å…·é“¾å¹¶é‡è¯•
    - name: ç¼–è¯‘å›ºä»¶ï¼ˆè‡ªåŠ¨æ¢å¤ï¼‰
      run: |
        cd openwrt
        make defconfig
        echo "å¼€å§‹ç¬¬ä¸€æ¬¡é«˜é€Ÿç¼–è¯‘..."
        make -j$(nproc) || {
          echo "âŒ ç¬¬ä¸€æ¬¡ç¼–è¯‘å¤±è´¥ï¼Œå¯èƒ½æ˜¯å·¥å…·é“¾æ±¡æŸ“"
          echo "ğŸ”§ æ‰§è¡Œ dirclean æ¸…ç† host toolchain..."
          make dirclean
          echo "â™»ï¸ å¼€å§‹ç¬¬äºŒæ¬¡ç¼–è¯‘ï¼ˆæ›´ç¨³å®šï¼‰..."
          make -j$(nproc) V=s
        }
      env:
        FORCE_UNSAFE_CONFIGURE: 1

    - name: æ‰“åŒ…å›ºä»¶
      id: package
      run: |
        cd openwrt/bin/targets
        TARGET_DIR=$(find . -type d -mindepth 1 -maxdepth 1)
        cd $TARGET_DIR
        mkdir -p $GITHUB_WORKSPACE/output
        cp -r * $GITHUB_WORKSPACE/output/
        cd $GITHUB_WORKSPACE/output
        ZIP_NAME=OpenWrt_$(date +%Y%m%d_%H%M).zip
        zip -r $ZIP_NAME .
        echo "firmware_zip=$ZIP_NAME" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ åˆ° Actions Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt-firmware
        path: output/

    # â­ è‡ªåŠ¨å‘å¸ƒ Release
    - name: å‘å¸ƒ Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: openwrt-${{ github.run_number }}-$(date +%Y%m%d)
        name: "OpenWrt è‡ªåŠ¨æ„å»º #${{ github.run_number }} ($(date +%Y-%m-%d))"
        files: output/${{ steps.package.outputs.firmware_zip }}
        body: |
          ğŸ‰ è‡ªåŠ¨æ„å»ºçš„ OpenWrt å›ºä»¶  
          - æºç ï¼š${{ env.REPO_URL }}  
          - åˆ†æ”¯ï¼š${{ env.REPO_BRANCH }}  
          - æ„å»ºæ—¶é—´ï¼š$(date +%Y-%m-%d\ %H:%M)  
          - ç‰ˆæœ¬å·ï¼š${{ github.run_number }}  

      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}