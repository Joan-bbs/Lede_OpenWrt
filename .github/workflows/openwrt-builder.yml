name: Build OpenWrt

on:
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * 5'  # æ¯å‘¨å…­å‡Œæ™¨ 4 ç‚¹ç¼–è¯‘

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # âœ… ç¼“å­˜ dlã€staging_dirã€build_dirï¼ŒåŠ å¿«é‡å¤ç¼–è¯‘
    - name: Cache OpenWrt build dependencies
      uses: actions/cache@v4
      with:
        path: |
          openwrt/dl
          openwrt/staging_dir
          openwrt/build_dir
        key: ${{ runner.os }}-openwrt-${{ env.REPO_BRANCH }}
        restore-keys: |
          ${{ runner.os }}-openwrt-

    - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
      run: |
        sudo apt update -y
        sudo apt full-upgrade -y
        sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext \
          genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
          libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
          libreadline-dev libssl-dev libtool llvm lrzsz libnsl-dev ninja-build p7zip p7zip-full patch pkgconf \
          python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion \
          swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev

    - name: å…‹éš† OpenWrt æºç 
      run: |
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt
        [ -f $GITHUB_WORKSPACE/$FEEDS_CONF ] && cp $GITHUB_WORKSPACE/$FEEDS_CONF ./feeds.conf.default

    - name: DIY ç¬¬1éƒ¨åˆ†
      run: |
        cd openwrt
        bash $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: æ›´æ–° & å®‰è£… feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: DIY ç¬¬2éƒ¨åˆ†
      run: |
        cd openwrt
        bash $GITHUB_WORKSPACE/$DIY_P2_SH

    - name: å¯¼å…¥è‡ªå®šä¹‰é…ç½®
      run: |
        cd openwrt
        [ -f $GITHUB_WORKSPACE/$CONFIG_FILE ] && cp $GITHUB_WORKSPACE/$CONFIG_FILE .config

    - name: ç¼–è¯‘å›ºä»¶
      run: |
        cd openwrt
        make defconfig
        make -j$(nproc) || make -j1 V=s
      env:
        FORCE_UNSAFE_CONFIGURE: 1

    - name: æ‰“åŒ…å›ºä»¶æ–‡ä»¶
      id: package
      run: |
        cd openwrt/bin/targets
        FIRMWARE_DIR=$(find . -type d -mindepth 1 -maxdepth 1)
        cd $FIRMWARE_DIR
        mkdir -p $GITHUB_WORKSPACE/output
        cp -r * $GITHUB_WORKSPACE/output/
        cd $GITHUB_WORKSPACE/output
        zip -r OpenWrt_firmware_$(date +%Y%m%d_%H%M).zip .
        echo "firmware_zip=$(ls OpenWrt_firmware_*.zip)" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶åˆ° GitHub Actions
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt-firmware
        path: output/

    # âœ… è‡ªåŠ¨åˆ›å»º Release å¹¶ä¸Šä¼ å›ºä»¶
    - name: å‘å¸ƒ Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: openwrt-${{ github.run_number }}-$(date +%Y%m%d)
        name: "OpenWrt è‡ªåŠ¨æ„å»º #${{ github.run_number }} ($(date +%Y-%m-%d))"
        files: output/${{ steps.package.outputs.firmware_zip }}
        body: |
          ğŸ‰ è‡ªåŠ¨æ„å»ºçš„ OpenWrt å›ºä»¶
          - æºç ï¼š${{ env.REPO_URL }}
          - åˆ†æ”¯ï¼š${{ env.REPO_BRANCH }}
          - ç¼–è¯‘æ—¶é—´ï¼š$(date +%Y-%m-%d\ %H:%M)
          - å·¥ä½œæµè¿è¡Œå·ï¼š${{ github.run_number }}

          ğŸ“¦ åŒ…å«çš„æ–‡ä»¶ï¼š
          ```
          ${{ steps.package.outputs.firmware_zip }}
          ```

      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}